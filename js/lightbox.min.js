/*!
 * Simple Lightbox Video - Fixed Version
 * Fixes HTTPS, event handling, and iframe interaction issues
 */
$(document).ready(function() {
    // Direct click handler for video elements
    $('.video').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var videoId = $(this).data('videoid');
        var videoSite = $(this).data('videosite');
        
        if (!videoId || !videoSite) {
            return false;
        }
        
        // Remove any existing lightbox
        $('#slvj-window').remove();
        
        // Calculate vertical centering
        var marginTop = window.innerHeight > 540 ? (window.innerHeight - 540) / 2 : 0;
        
        // Create lightbox HTML structure
        var iframe = '<iframe src="" width="640" height="480" id="slvj-video-embed" style="border:0;" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
        var closeIcon = '<div id="slvj-close-icon"></div>';
        var lightboxContainer = '<div class="slvj-lightbox" style="margin-top:' + marginTop + 'px">';
        var backLightbox = '<div id="slvj-back-lightbox">';
        var backgroundClose = '<div id="slvj-background-close"></div>';
        var windowDiv = '<div id="slvj-window">';
        var endDivs = '</div></div></div>';
        
        // Append lightbox to body
        $('body').append(windowDiv + backgroundClose + backLightbox + lightboxContainer + closeIcon + iframe + endDivs);
        
        // Hide initially
        $('#slvj-window').hide();
        
        // Determine video URL based on site (FIXED: Use HTTPS)
        var videoUrl = '';
        if (videoSite === 'youtube') {
            videoUrl = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1&rel=0&enablejsapi=1';
        } else if (videoSite === 'vimeo') {
            videoUrl = 'https://player.vimeo.com/video/' + videoId + '?autoplay=1';
        }
        
        // Show lightbox and set video source
        $('#slvj-window').fadeIn();
        $('#slvj-video-embed').attr('src', videoUrl);
        
        // Focus management for accessibility
        $('#slvj-close-icon').focus();
        
        // Close button functionality
        $('#slvj-close-icon').click(function(e) {
            e.stopPropagation();
            $('#slvj-window').fadeOut(300, function() {
                $(this).remove();
            });
        });
        
        // Background close functionality
        $('#slvj-background-close').click(function(e) {
            $('#slvj-window').fadeOut(300, function() {
                $(this).remove();
            });
        });
        
        // Prevent lightbox content clicks from closing
        $('.slvj-lightbox').click(function(e) {
            e.stopPropagation();
        });
        
        // Prevent iframe clicks from bubbling up
        $('#slvj-video-embed').click(function(e) {
            e.stopPropagation();
        });
        
        // Better back lightbox event handling
        $('#slvj-back-lightbox').click(function(e) {
            if (e.target === this) {
                $('#slvj-window').fadeOut(300, function() {
                    $(this).remove();
                });
            }
        });
        
        // ESC key handler
        $(document).on('keyup.lightbox', function(e) {
            if (e.keyCode === 27) {
                $('#slvj-window').fadeOut(300, function() {
                    $(this).remove();
                });
                $(document).off('keyup.lightbox');
            }
        });
        
        return false;
    });
});